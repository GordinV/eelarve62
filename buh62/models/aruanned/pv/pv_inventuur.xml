<?xml version = "1.0" encoding="Windows-1252" standalone="yes"?>
<VFPData>
  <grid>
    <sql>        WITH
                                params as (
                                              select
                                                  $1::date    as kpv,
                                                  $2::integer as rekvid,
                                                  $3::integer as kond
                                          ),
                                rekv_ids AS (
                                              SELECT
                                                  rekv_id
                                              FROM
                                                  params p, get_asutuse_struktuur(p.rekvid)
                                              WHERE
                                                  rekv_id = CASE
                                                                WHEN p.kond = 1
                                                                    THEN rekv_id
                                                                ELSE p.rekvid END
                                          ),
                                cur_pv as (
                                              SELECT
                                                  l.id,
                                                  l.kood,
                                                  l.nimetus,
                                                  l.rekvid,
                                                  coalesce(a.nimetus, '') :: VARCHAR(254)                                                AS vastisik,
                                                  (l.properties :: JSONB -&gt;&gt; 'vastisikid') :: INTEGER                                    AS vastisikid,
                                                  coalesce((l.properties :: JSONB -&gt;&gt; 'algkulum') :: NUMERIC(12, 2), 0):: NUMERIC(12, 2) AS algkulum,
                                                  (l.properties :: JSONB -&gt;&gt; 'kulum') :: NUMERIC(12, 2)                                  AS kulum,
                                                  (l.properties :: JSONB -&gt;&gt; 'soetmaks') :: NUMERIC(12, 2)                               AS soetmaks,
                                                  coalesce((l.properties :: JSONB -&gt;&gt; 'parhind') :: NUMERIC(12, 2),
                                                           (l.properties :: JSONB -&gt;&gt; 'soetmaks') :: NUMERIC(12, 2))                     AS parhind,
                                                  coalesce((l.properties :: JSONB -&gt;&gt; 'kulum_kokku') :: NUMERIC(12, 2),
                                                           0) :: NUMERIC(12, 2)                                                          AS kulum_kokku,
                                                  coalesce((l.properties :: JSONB -&gt;&gt; 'jaak') :: NUMERIC(12, 2), 0) :: NUMERIC(12, 2)    AS jaak,
                                                  coalesce((l.properties :: JSONB -&gt;&gt; 'soetkpv') :: DATE,
                                                           date(1900, 01, 01))                                                           AS soetkpv,
                                                  coalesce((l.properties :: JSONB -&gt;&gt; 'konto'), '') :: VARCHAR(20)                       AS konto,
                                                  coalesce((l.properties :: JSONB -&gt;&gt; 'tunnus'), '') :: VARCHAR(20)                      AS tunnus,
                                                  (l.properties :: JSONB -&gt;&gt; 'mahakantud') :: DATE                                       AS mahakantud,
                                                  coalesce((l.properties :: JSONB -&gt;&gt; 'rentnik'), '') :: VARCHAR(120)                    AS rentnik,
                                                  (l.properties :: JSONB -&gt;&gt; 'liik') :: VARCHAR(120)                                     AS liik,
                                                  coalesce((l.properties :: JSONB -&gt;&gt; 'selg'), '') :: VARCHAR(120)                       AS selgitus,
                                                  (l.properties :: JSONB -&gt;&gt; 'parent_id') :: INTEGER                                     AS parent_id,
                                                  coalesce((l.properties :: JSONB -&gt;&gt; 'pindala') :: NUMERIC(12, 4), 0):: NUMERIC(12, 4)  AS pindala,
                                                  libs.get_pv_kaart_grupp(l.id, p.kpv)                                                   AS gruppid,
                                                  coalesce((l.properties :: JSONB -&gt;&gt; 'aadress'), ''):: VARCHAR(254)                     AS aadress,
                                                  l.status
                                              FROM
                                                  params                    p,
                                                  libs.library              l
                                                      LEFT JOIN libs.asutus a
                                                                ON (l.properties :: JSONB -&gt; 'vastisikid') = to_jsonb(a.id)
                                              WHERE
                                                    l.status &lt;&gt; 3
                                                AND l.rekvid IN (
                                                                    SELECT
                                                                        rekv_id
                                                                    FROM
                                                                        rekv_ids
                                                                )
                                          )
                            SELECT
                                coalesce((
                                             SELECT
                                                 sum(summa)
                                             FROM
                                                 docs.pv_oper po
                                             WHERE
                                                   po.pv_kaart_id = pv.id
                                               AND po.kpv &lt;= p.kpv::DATE
                                               AND liik = 2
                                         ), 0) + pv.algkulum                             AS arv_kulum,
                                coalesce((
                                             SELECT
                                                 sum(summa)
                                             FROM
                                                 docs.pv_oper po
                                             WHERE
                                                   po.pv_kaart_id = pv.id
                                               AND liik IN (1, 3)
                                               AND po.kpv &lt;= p.kpv::DATE
                                         ), 0)                                           AS soetmaks,
                                (
                                    SELECT eluiga FROM libs.get_pv_kaart_jaak(pv.id::INTEGER, p.kpv::DATE)
                                )::NUMERIC(12, 4)                                        AS eluiga,
                                pv.id,
                                libs.get_pv_kaart_konto(pv.id, p.kpv::date)::varchar(20) as konto,
                                pv.tunnus,
                                pv.rekvid,
                                pv.kulum,
                                pv.nimetus,
                                pv.kood,
                                pv.liik,
                                pv.soetkpv,
                                pv.jaak,
                                pv.algkulum,
                                pv.aadress,
                                grupp.nimetus                                            as grupp,
                                pv.gruppid,
                                pv.kulum_kokku,
                                pv.mahakantud,
                                pv.vastisik,
                                pv.vastisikid,
                                pv.rentnik,
                                r.nimetus                                                as asutus
                            FROM
                                params                      p,
                                cur_pv                      pv
                                    JOIN       libs.library grupp ON pv.gruppid = grupp.id
                                    inner join ou.rekv      r on r.id = pv.rekvid
                            WHERE
                                  (pv.mahakantud IS NULL or pv.mahakantud &gt; p.kpv)
                              and pv.soetkpv &lt;= p.kpv::DATE
        </sql>
    <alias>pv_inventuur_report</alias>
  </grid>
  <select></select>
  <selectAsLibs>
    <sql></sql>
    <alias>selectAsLibs</alias>
  </selectAsLibs>
  <saveDoc>
    <sql></sql>
    <alias>saveDoc</alias>
  </saveDoc>
  <deleteDoc>
    <sql></sql>
    <alias>deleteDoc</alias>
  </deleteDoc>
  <requiredFields>
    <validate></validate>
  </requiredFields>
  <executeSql>
    <sql></sql>
    <alias></alias>
  </executeSql>
  <executeCommand>
    <sql></sql>
    <alias></alias>
  </executeCommand>
  <register>
    <sql></sql>
    <alias></alias>
  </register>
  <endProcess>
    <sql />
    <alias />
  </endProcess>
  <generateJournal>
    <sql />
    <alias />
  </generateJournal>
  <print></print>
  <getLog>
    <sql />
    <alias />
  </getLog>
</VFPData>
