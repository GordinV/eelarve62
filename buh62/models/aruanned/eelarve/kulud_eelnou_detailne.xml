<?xml version = "1.0" encoding="Windows-1252" standalone="yes"?>
<VFPData>
  <grid>
    <sql>WITH report AS (
                SELECT qryReport.idx,
                       qryReport.rekv_id,
                       qryReport.tunnus,
                       qryReport.tegev,
                       qryReport.artikkel,
                       qryReport.aasta_1_tekke_taitmine,
                       qryReport.eelarve_tekkepohine_kinnitatud,
                       qryReport.eelarve_tekkepohine_tapsustatud,
                       qryReport.aasta_2_tekke_taitmine,
                       qryReport.aasta_3_eelnou,
                       qryReport.aasta_3_prognoos,
                       qryReport.selg AS selg
                FROM eelarve.kulud_eelnou($1::DATE, $2::INTEGER, $3::INTEGER) qryReport
                WHERE artikkel &lt;&gt; ''
            ),
                 TegevKond AS (
                     SELECT 0                                        AS idx,
                            rekv_id                                  AS rekv_id,
                            ''                                       AS tunnus,
                            left(qry.tegev, 2)::VARCHAR(20)          AS tegev,
                            ''                                       AS artikkel,
                            sum(qry.aasta_1_tekke_taitmine)          AS aasta_1_tekke_taitmine,
                            sum(qry.eelarve_tekkepohine_kinnitatud)  AS eelarve_tekkepohine_kinnitatud,
                            sum(qry.eelarve_tekkepohine_tapsustatud) AS eelarve_tekkepohine_tapsustatud,
                            sum(qry.aasta_2_tekke_taitmine)          AS aasta_2_tekke_taitmine,
                            sum(qry.aasta_3_eelnou)                  AS aasta_3_eelnou,
                            sum(qry.aasta_3_prognoos)                AS aasta_3_prognoos,
                            ''                                       AS selg
                     FROM report qry
                     WHERE NOT empty(qry.tegev)
                     GROUP BY qry.rekv_id, left(qry.tegev, 2)
                 )
            
            SELECT (ltrim(rtrim(CASE
                                    WHEN p.id = r.id THEN ''
                                    WHEN r.id = 999999 THEN ''
                                    ELSE coalesce(p.nimetus, '') END)) || ' ' ||
                    ltrim(rtrim(r.nimetus)))::VARCHAR(254)       AS asutus,
                   qryReport.tunnus,
                   qryReport.tegev,
                   coalesce(t.nimetus, '')::VARCHAR(254)         AS tegev_nimetus,
                   coalesce(qryReport.artikkel, '')::VARCHAR(20) AS artikkel,
                   coalesce(a.nimetus, '')::VARCHAR(254)         AS nimetus,
                   qryReport.aasta_1_tekke_taitmine,
                   qryReport.eelarve_tekkepohine_kinnitatud,
                   qryReport.eelarve_tekkepohine_tapsustatud,
                   qryReport.aasta_2_tekke_taitmine,
                   qryReport.aasta_3_eelnou,
                   qryReport.aasta_3_prognoos,
                   qryReport.selg                                AS selg
            FROM (SELECT *
                  FROM report
                  UNION ALL
                  SELECT *
                  FROM TegevKond
                 ) qryReport
                     INNER JOIN (SELECT id, parentid, regkood, nimetus
                                 FROM ou.rekv
                                 WHERE parentid &lt; 999
                                 UNION ALL
                                 SELECT 999999, 0, '' AS regkood, 'Kond' AS nimetus
                                 WHERE $3::INTEGER = 1
                                 UNION ALL
                                 SELECT 0 AS id, 0 AS parentid, r.regkood, r.nimetus
                                 FROM ou.rekv r
                                 WHERE r.id = $2
                                   AND $3::INTEGER = 1
            ) r
                                ON r.id = qryReport.rekv_id
                     LEFT OUTER JOIN ou.rekv p ON r.parentid = p.id
                     LEFT OUTER JOIN (SELECT id, kood, nimetus
                                      FROM libs.library a
                                      WHERE library = 'TULUDEALLIKAD'
                                        AND status &lt; 3) a
                                     ON a.kood = qryReport.artikkel
                     LEFT OUTER JOIN (SELECT id, kood, nimetus
                                      FROM libs.library
                                      WHERE library = 'TEGEV'
                                        AND status &lt; 3
                                      UNION ALL
                                      SELECT id, kood, nimetus
                                      FROM cur_tegev_kond
            ) t
                                     ON trim(t.kood)::TEXT = trim(qryReport.tegev)::TEXT
            
            
            ORDER BY CASE WHEN r.id &gt; 999 THEN 0 WHEN r.id = $2 THEN 1 ELSE r.id END, r.parentid,
                     qryReport.rekv_id, qryReport.tegev, qryReport.tunnus, qryReport.artikkel</sql>
    <alias>kulud_eelnou</alias>
  </grid>
  <select></select>
  <selectAsLibs>
    <sql></sql>
    <alias>selectAsLibs</alias>
  </selectAsLibs>
  <saveDoc>
    <sql></sql>
    <alias>saveDoc</alias>
  </saveDoc>
  <deleteDoc>
    <sql></sql>
    <alias>deleteDoc</alias>
  </deleteDoc>
  <requiredFields>
    <validate></validate>
  </requiredFields>
  <executeSql>
    <sql></sql>
    <alias></alias>
  </executeSql>
  <executeCommand>
    <sql></sql>
    <alias></alias>
  </executeCommand>
  <register>
    <sql></sql>
    <alias></alias>
  </register>
  <endProcess>
    <sql />
    <alias />
  </endProcess>
  <generateJournal>
    <sql />
    <alias />
  </generateJournal>
  <print></print>
  <getLog>
    <sql />
    <alias />
  </getLog>
</VFPData>
